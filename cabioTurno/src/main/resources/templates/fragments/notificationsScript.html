<div th:fragment="notificationsScript">
	<script>
		const notificationSocket = new WebSocket('ws://localhost:8080/ws/notifications');

		notificationSocket.onopen = function () {
			console.log('WebSocket connection established');
		};

		notificationSocket.onmessage = function (event) {
			console.log('Message received:', event.data);

			const notificationCount = document.getElementById('notification-count');
			if (notificationCount) {
				const newCount = parseInt(notificationCount.innerText || '0') + 1;
				notificationCount.innerText = newCount;
				notificationCount.style.display = 'inline';
			}

			const notification = JSON.parse(event.data);
			const notificationList = document.getElementById('notification-list');
			if (notificationList) {
				const newNotificationItem = document.createElement('a');
				newNotificationItem.className = 'dropdown-item';
				newNotificationItem.innerText = notification.descripcion;
				notificationList.prepend(newNotificationItem);
			}
		};

		notificationSocket.onerror = function (error) {
			console.log('WebSocket error:', error);
		};

		notificationSocket.onclose = function () {
			console.log('WebSocket connection closed');
		};

		// Leer el token CSRF del meta tag
		const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

		// Evento para resetear el contador de notificaciones y marcar como leídas
		document.getElementById('notificationsDropdown').addEventListener('hidden.bs.dropdown', function () {
			const notificationCount = document.getElementById('notification-count');
			if (notificationCount) {
				notificationCount.innerText = '';
				notificationCount.style.display = 'none';
			}

			// Lógica para marcar las notificaciones como leídas en el backend
			fetch('/marcarNotificacionesComoLeidas', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					[csrfHeader]: csrfToken // Incluir el token CSRF en la solicitud
				},
				credentials: 'include' // Asegura que las cookies de sesión se envíen con la solicitud
			}).then(response => {
				if (response.ok) {
					console.log('Notificaciones marcadas como leídas');
				} else {
					console.log('Error al marcar las notificaciones como leídas');
					return response.text().then(text => {throw new Error(text);});
				}
			}).catch(error => {
				console.log('Error en la solicitud de marcado como leído:', error);
			});
		});
	</script>

	<script>
		function confirmDelete(button) {
			var id = button.getAttribute("data-id");
			var url = "/cambioTurno/delete/" + id;
			var confirmDeleteButton = document.getElementById("confirmDeleteButton");
			confirmDeleteButton.setAttribute("href", url);
			var modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
			modal.show();
		}
	</script>

	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</div>